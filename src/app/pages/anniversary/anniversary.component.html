<!-- anniversary.component.html -->
<div class="anniversary-container">

    <!-- Back Arrow -->
    <div class="back-arrow-container">
        <button class="back-arrow-btn" (click)="logout()" title="Logout">
        <svg class="back-arrow-icon" viewBox="0 0 24 24">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        <span class="back-text">Logout</span>
    </button>
    </div>

    <div class="header">
        <h5>15th Anniversary Products Tracking</h5>
        <p>Monitor orders, payments, and deliveries for anniversary products</p>
    </div>

    <!-- Segment 1: Forms -->
    <div class="segment forms-segment">
        <h3>Data Entry</h3>
        <div class="form-buttons">
            <button class="btn btn-primary" (click)="toggleForm('order')" [class.active]="activeForm === 'order'" [disabled]="loading.submitting">
        {{ activeForm === 'order' ? 'Cancel Order' : 'New Order' }}
      </button>
            <button class="btn btn-success" (click)="toggleForm('receipt')" [class.active]="activeForm === 'receipt'" [disabled]="loading.submitting">
        {{ activeForm === 'receipt' ? 'Cancel Receipt' : 'New Receipt' }}
      </button>
            <button class="btn btn-info" (click)="toggleForm('delivery')" [class.active]="activeForm === 'delivery'" [disabled]="loading.submitting">
        {{ activeForm === 'delivery' ? 'Cancel Delivery' : 'Record Delivery' }}
      </button>
        </div>

        <!-- Loading state for forms -->
        <div *ngIf="loading.products || loading.churches" class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Loading form data...
        </div>

        <!-- Order Form -->
        <div class="form-container" *ngIf="activeForm === 'order' && !loading.products && !loading.churches">
            <h4>Submit New Order</h4>
            <form [formGroup]="orderForm" (ngSubmit)="submitOrder()">
                <div class="form-group">
                    <label>Church</label>
                    <select formControlName="church" class="form-control">
            <option value="">Select Church</option>
            <option *ngFor="let church of churches" [value]="church.id">{{ church.name }}</option>
          </select>
                    <div *ngIf="orderForm.get('church')?.invalid && orderForm.get('church')?.touched" class="text-danger">
                        Church is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Product</label>
                    <select formControlName="product" class="form-control">
            <option value="">Select Product</option>
            <option *ngFor="let product of products" [value]="product.id">
              {{ product.name }} - ${{ product.price }} ({{ product.size }})
            </option>
          </select>
                    <div *ngIf="orderForm.get('product')?.invalid && orderForm.get('product')?.touched" class="text-danger">
                        Product is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" formControlName="qty" class="form-control" min="1">
                    <div *ngIf="orderForm.get('qty')?.invalid && orderForm.get('qty')?.touched" class="text-danger">
                        Valid quantity is required (minimum 1)
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" [disabled]="!orderForm.valid || loading.submitting">
          <span *ngIf="loading.submitting" class="spinner-border spinner-border-sm" role="status"></span>
          {{ loading.submitting ? 'Submitting...' : 'Submit Order' }}
        </button>
            </form>
        </div>

        <!-- Receipt Form -->
        <div class="form-container" *ngIf="activeForm === 'receipt' && !loading.products && !loading.churches">
            <h4>Record Payment Receipt</h4>
            <form [formGroup]="receiptForm" (ngSubmit)="submitReceipt()">
                <div class="form-group">
                    <label>Church</label>
                    <select formControlName="church" class="form-control">
            <option value="">Select Church</option>
            <option *ngFor="let church of churches" [value]="church.id">{{ church.name }}</option>
          </select>
                    <div *ngIf="receiptForm.get('church')?.invalid && receiptForm.get('church')?.touched" class="text-danger">
                        Church is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Product</label>
                    <select formControlName="product" class="form-control">
            <option value="">Select Product</option>
            <option *ngFor="let product of products" [value]="product.id">
              {{ product.name }}
            </option>
          </select>
                    <div *ngIf="receiptForm.get('product')?.invalid && receiptForm.get('product')?.touched" class="text-danger">
                        Product is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" formControlName="amount" class="form-control" min="0" step="0.01">
                    <div *ngIf="receiptForm.get('amount')?.invalid && receiptForm.get('amount')?.touched" class="text-danger">
                        Valid amount is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select formControlName="method" class="form-control">
            <option value="cash">Cash</option>
            <option value="momo">Mobile Money</option>
            <option value="transfer">Bank Transfer</option>
          </select>
                </div>
                <div class="form-group">
                    <label>Deposited At</label>
                    <select formControlName="deposited_at" class="form-control">
            <option value="local_treasury">Local Treasury</option>
            <option value="district_treasury">District Treasury</option>
          </select>
                </div>
                <button type="submit" class="btn btn-success" [disabled]="!receiptForm.valid || loading.submitting">
          <span *ngIf="loading.submitting" class="spinner-border spinner-border-sm" role="status"></span>
          {{ loading.submitting ? 'Submitting...' : 'Submit Receipt' }}
        </button>
            </form>
        </div>

        <!-- Delivery Form -->
        <div class="form-container" *ngIf="activeForm === 'delivery' && !loading.products && !loading.churches">
            <h4>Record Order Delivery</h4>
            <form [formGroup]="deliveryForm" (ngSubmit)="submitDelivery()">
                <div class="form-group">
                    <label>Church</label>
                    <select formControlName="church" class="form-control">
            <option value="">Select Church</option>
            <option *ngFor="let church of churches" [value]="church.id">{{ church.name }}</option>
          </select>
                    <div *ngIf="deliveryForm.get('church')?.invalid && deliveryForm.get('church')?.touched" class="text-danger">
                        Church is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Product</label>
                    <select formControlName="product" class="form-control">
            <option value="">Select Product</option>
            <option *ngFor="let product of products" [value]="product.id">
              {{ product.name }}
            </option>
          </select>
                    <div *ngIf="deliveryForm.get('product')?.invalid && deliveryForm.get('product')?.touched" class="text-danger">
                        Product is required
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity Delivered</label>
                    <input type="number" formControlName="qty" class="form-control" min="1">
                    <div *ngIf="deliveryForm.get('qty')?.invalid && deliveryForm.get('qty')?.touched" class="text-danger">
                        Valid quantity is required (minimum 1)
                    </div>
                </div>
                <button type="submit" class="btn btn-info" [disabled]="!deliveryForm.valid || loading.submitting">
          <span *ngIf="loading.submitting" class="spinner-border spinner-border-sm" role="status"></span>
          {{ loading.submitting ? 'Submitting...' : 'Record Delivery' }}
        </button>
            </form>
        </div>
    </div>

    <!-- Segment 2: Dashboard -->
    <div class="segment dashboard-segment">
        <div class="segment-header">
            <h3>Orders & Payments Dashboard</h3>
            <button class="btn btn-outline-primary btn-sm" (click)="exportOrders()">
              Export Orders
           </button>
            <button class="btn btn-outline-primary btn-sm" (click)="exportReceipts()">
              Export Receipts
           </button>
        </div>

        <div *ngIf="loading.metrics" class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            Loading dashboard metrics...
        </div>

        <div *ngIf="!loading.metrics">
            <div class="metrics-grid" data-aos="fade-up" data-aos-delay="500">
                <div class="metric-card" data-aos="fade-up" data-aos-delay="500">
                    <div class="metric-value">{{ metrics.totalOrders || 0 }}</div>
                    <div class="metric-label">Total Orders</div>
                </div>
                <div class="metric-card" data-aos="fade-left" data-aos-delay="500">
                    <div class="metric-value">GH{{ (metrics.totalReceipts || 0) | number:'1.2-2' }}</div>
                    <div class="metric-label">Total Receipts</div>
                </div>
                <div class="metric-card" data-aos="fade-right" data-aos-delay="500">
                    <div class="metric-value">GH{{ (metrics.totalExpectedValue || 0) | number:'1.2-2' }}</div>
                    <div class="metric-label">Expected Order Value</div>
                </div>
                <div class="metric-card" data-aos="fade-left" data-aos-delay="500">
                    <div class="metric-value">{{ metrics.totalDelivered || 0 }}</div>
                    <div class="metric-label">Total Delivered</div>
                </div>
            </div>

            <div class="charts-grid" data-aos="fade-up" data-aos-delay="500">

                <div class="chart-card">
                    <h5>Orders by Church</h5>
                    <div class="chart-content">
                        <!-- Loop through each church -->
                        <div *ngFor="let churchData of metrics?.ordersByChurch" class="church-group">
                            <!-- Church header -->
                            <div class="church-header">
                                <span class="church-name">{{ churchData.church }}</span>
                                <span class="church-total">
                                    Total: {{ getChurchTotalOrders(churchData) }} orders 
                                    (GH{{ getChurchTotalValue(churchData) | number:'1.2-2' }})
                                </span>
                            </div>

                            <!-- Loop through products for this church -->
                            <div *ngFor="let product of churchData.products" class="product-item">
                                <span class="product-name">{{ product.product }}</span>
                                <span class="product-value">
                                {{ product.count }} orders (GH{{ product.value | number:'1.2-2' }})
                            </span>
                            </div>

                            <!-- Divider between churches -->
                            <div class="church-divider" *ngIf="!isLast(churchData, metrics.ordersByChurch)"></div>
                        </div>

                        <div *ngIf="!metrics?.ordersByChurch?.length" class="no-data">
                            No orders data available
                        </div>
                    </div>
                </div>


                <div class="chart-card">
                    <h5>Receipts by Church</h5>
                    <div class="chart-content">
                        <!-- Loop through each church -->
                        <div *ngFor="let churchData of metrics?.receiptsByChurch" class="church-group">
                            <!-- Church header -->
                            <div class="church-header">
                                <span class="church-name">{{ churchData.church }}</span>
                                <span class="church-total">
                            Total: GH{{ getChurchTotalReceipts(churchData) | number:'1.2-2' }}
                        </span>
                            </div>

                            <!-- Loop through products for this church -->
                            <div *ngFor="let product of churchData.products" class="product-item">
                                <span class="product-name">{{ product.product }}</span>
                                <span class="product-value">
                            GH{{ product.amount | number:'1.2-2' }}
                        </span>
                            </div>

                            <!-- Divider between churches -->
                            <div class="church-divider" *ngIf="!isLast(churchData, metrics.receiptsByChurch)"></div>
                        </div>

                        <div *ngIf="!metrics?.receiptsByChurch?.length" class="no-data">
                            No receipts data available
                        </div>
                    </div>
                </div>


                <!-- <div class="chart-card">
                    <h5>Orders by Product</h5>
                    <div class="chart-content">
                        <div *ngFor="let item of metrics?.ordersByProduct" class="chart-item">
                            <span class="product-name">{{ item.product }}</span>
                            <span class="product-value">{{ item.qty }} units (GH{{ item.value | number:'1.2-2' }})</span>
                        </div>
                        <div *ngIf="!metrics?.ordersByProduct?.length" class="no-data">
                            No product orders data available
                        </div>
                    </div>
                </div> -->


                <div class="chart-card">
                    <h5>Orders by Product</h5>
                    <div class="products-grid">
                        <!-- Product Cards -->
                        <div *ngFor="let item of metrics?.ordersByProduct" class="product-card">
                            <div class="product-header">
                                <h6 class="product-title">{{ item.product }}</h6>
                                <div class="product-badge">
                                    {{ item.qty }} units
                                </div>
                            </div>

                            <div class="product-stats">
                                <div class="stat">
                                    <span class="stat-label">Total Value</span>
                                    <span class="stat-value">GH{{ item.value | number:'1.2-2' }}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Price</span>
                                    <span class="stat-value  text-danger">GH{{ (item.value / item.qty) | number:'1.2-2' }}</span>
                                </div>
                            </div>

                            <div class="progress-section">
                                <div class="progress-info">
                                    <span>Revenue Contribution</span>
                                    <span>{{ getProductContribution(item.value) }}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" [style.width]="getProductContribution(item.value) + '%'" [style.background]="getProductColor(item.product)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- No Data State -->
                        <div *ngIf="!metrics?.ordersByProduct?.length" class="no-data-card">
                            <div class="no-data-icon">ðŸ“Š</div>
                            <p>No product orders data available</p>
                            <small>Orders will appear here once they are submitted</small>
                        </div>
                    </div>
                </div>




            </div>
        </div>
    </div>

    <!-- Segment 3: Orders vs Deliveries -->
    <!-- <div class="segment delivery-segment">
        <h3>Orders vs Deliveries</h3>

        <div *ngIf="loading.deliveries" class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            Loading delivery data...
        </div>

        <div *ngIf="!loading.deliveries">
            <div class="delivery-table">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Church</th>
                            <th>Orders</th>
                            <th>Deliveries</th>
                            <th>Pending</th>
                            <th>Completion</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of ordersVsDeliveries">
                            <td><strong>{{ item.church }}</strong></td>
                            <td>{{ item.orders }}</td>
                            <td>{{ item.deliveries }}</td>
                            <td>
                                <span [class]="item.pending > 0 ? 'text-warning' : 'text-success'">
                  {{ item.pending }}
                </span>
                            </td>
                            <td>
                                <div class="completion-container">
                                    <div class="progress">
                                        <div class="progress-bar" [class]="getCompletionClass(item.orders, item.deliveries)" [style.width]="getCompletionPercent(item.orders, item.deliveries) + '%'">
                                            {{ getCompletionPercent(item.orders, item.deliveries) }}%
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="!ordersVsDeliveries?.length">
                            <td colspan="5" class="text-center text-muted">
                                No delivery data available
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div> -->


    <!-- Segment 3: Orders vs Deliveries -->
    <div class="segment delivery-segment">
        <h3>Orders vs Deliveries</h3>

        <div *ngIf="loading.deliveries" class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            Loading delivery data...
        </div>

        <div *ngIf="!loading.deliveries">
            <!-- Desktop Table (hidden on mobile) -->
            <div class="delivery-table d-none d-md-block">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Church</th>
                            <th>Product</th>
                            <th>Orders</th>
                            <th>Deliveries</th>
                            <th>Pending</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of ordersVsDeliveries">
                            <td><strong>{{ item.church }}</strong></td>
                            <td>{{ item.product }}</td>
                            <td>{{ item.orders }}</td>
                            <td>{{ item.deliveries }}</td>
                            <td>
                                <span [class]="getPendingClass(item.pending)">
                                {{ item.pending }}
                            </span>
                            </td>
                            <td>
                                <div class="completion-container">
                                    <div class="progress">
                                        <div class="progress-bar" [class]="getCompletionClass(item.orders, item.deliveries)" [style.width]="getCompletionPercent(item.orders, item.deliveries) + '%'">
                                            {{ getCompletionPercent(item.orders, item.deliveries) }}%
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="!ordersVsDeliveries?.length">
                            <td colspan="6" class="text-center text-muted">
                                No delivery data available
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards (visible only on mobile) -->
            <div class="delivery-cards d-md-none">
                <div *ngFor="let item of ordersVsDeliveries" class="delivery-card">
                    <div class="card-header">
                        <h6 class="church-name">{{ item.church }}</h6>
                        <span class="product-name">{{ item.product }}</span>
                    </div>
                    <div class="card-body" data-aos="fade-up" data-aos-delay="500">
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Orders</span>
                                <span class="stat-value">{{ item.orders }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Delivered</span>
                                <span class="stat-value">{{ item.deliveries }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pending</span>
                                <span class="stat-value" [class]="getPendingClass(item.pending)">
                                {{ item.pending }}
                            </span>
                            </div>
                        </div>
                        <div class="progress-section">
                            <div class="progress-label">Completion</div>
                            <div class="progress">
                                <div class="progress-bar" [class]="getCompletionClass(item.orders, item.deliveries)" [style.width]="getCompletionPercent(item.orders, item.deliveries) + '%'">
                                    {{ getCompletionPercent(item.orders, item.deliveries) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="!ordersVsDeliveries?.length" class="no-data-mobile">
                    <div class="text-center text-muted">
                        No delivery data available
                    </div>
                </div>
            </div>
        </div>
    </div>



</div>